<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Resumen de Jugada</title>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
@page { size: letter; margin:0.7in; }
body { font-family:Arial; }

.detalle-grid {
  display:grid;
  grid-template-columns:repeat(8,1fr);
  gap:14px;
}

.detalle-card {
  border:1px solid #eaeaea;
  border-radius:6px;
  padding:10px;
  text-align:center;
  break-inside:avoid;
}

.footer-print {
  display:flex;
  justify-content:space-between;
  margin-top:20px;
  font-size:12px;
  color:#555;
}

@media print {
  body { counter-reset: page; }
  .page-counter::after {
    counter-increment: page;
    content:"Página " counter(page) " de " counter(pages);
  }
}
</style>
</head>

<body>

<div id="jugadaCarta" style="display:none">

<h2>GESTIÓN DE NÚMEROS</h2>

<p>ID: <span id="idjugada"></span></p>
<p>Fecha: <span id="fecha"></span></p>
<p>Hora: <span id="hora"></span></p>
<p>Usuario: <span id="usuario"></span></p>

<svg id="barcode"></svg>

<div id="detallePagesContainer" class="detalle-grid"></div>

<div class="footer-print">
  <span id="fechaImpresion"></span>
  <span class="page-counter"></span>
</div>

</div>

<script>
const URL_JUGADA  = "https://opensheet.elk.sh/1ZcHPnYe03lLPNb07yTmxCf75ShifXVWbuFTF6kN_vH4/JUGADA";
const URL_DETALLE = "https://opensheet.elk.sh/1ZcHPnYe03lLPNb07yTmxCf75ShifXVWbuFTF6kN_vH4/DETALLE";
const URL_VENTAS  = "https://opensheet.elk.sh/1ZcHPnYe03lLPNb07yTmxCf75ShifXVWbuFTF6kN_vH4/VENTAS";

const getParam = p => new URLSearchParams(location.search).get(p);

function normalizarClave(f,h){
  return (f+" "+h).trim().replace(/\s+/g," ").toUpperCase();
}
function equalsUser(a,b){
  return (a||"").trim().toUpperCase() === (b||"").trim().toUpperCase();
}

const id = getParam("id");
document.getElementById("idjugada").textContent = id;

Promise.all([
  fetch(URL_JUGADA).then(r=>r.json()),
  fetch(URL_DETALLE).then(r=>r.json()),
  fetch(URL_VENTAS).then(r=>r.json())
]).then(([jugadas, detalles, ventas])=>{

  const jugada = jugadas.find(j=>j.ID==id);
  const user = jugada.USUARIO;
  const clave = normalizarClave(jugada.FECHA,jugada.HORA);

  document.getElementById("fecha").textContent = jugada.FECHA;
  document.getElementById("hora").textContent = jugada.HORA;
  document.getElementById("usuario").textContent = user;

  JsBarcode("#barcode", id, {displayValue:false});

  const ventasMap = new Map();
  ventas.forEach(v=>ventasMap.set(v.ID,v.ESTADO));

  const filtrados = detalles.filter(d=>{
    return normalizarClave(d.FECHA,d.JUEGA)===clave &&
           d.ESTADO==="ACTIVO" &&
           equalsUser(d.USUARIO,user) &&
           (!d.VENTA || ventasMap.get(d.VENTA)==="ACTIVO");
  });

  filtrados.sort((a,b)=>{
    const na=parseInt(a.NUMERO), nb=parseInt(b.NUMERO);
    if(!isNaN(na)&&!isNaN(nb)) return na-nb;
    return a.NUMERO.localeCompare(b.NUMERO);
  });

  const cont = document.getElementById("detallePagesContainer");
  filtrados.forEach(d=>{
    cont.innerHTML += `
      <div class="detalle-card">
        <div>#${d.NUMERO}</div>
        <div>L ${Math.round(d.VALOR)}</div>
      </div>`;
  });

  document.getElementById("fechaImpresion").textContent =
    "Impreso: " + new Date().toLocaleString();

  document.getElementById("jugadaCarta").style.display="block";
  setTimeout(()=>window.print(),800);
});
</script>

</body>
</html>
